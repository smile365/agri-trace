<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掌上农场 - 土鸡养殖追溯系统</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .play-pause-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        
        .play-pause-button i {
            font-size: 24px;
        }
        
        .player {
            position: relative;
        }
    </style>
    
</head>
<body>
    <!-- 加载状态 -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>正在加载农场数据...</p>
        </div>
    </div>

    <!-- 错误状态 -->
    <div id="errorContainer" class="error-container" style="display: none;">
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="errorMessage"></p>
            <button id="retryButton" class="retry-button">重试</button>
        </div>
    </div>

    <!-- 主页面 -->
    <div id="mainPage" class="page active" style="display: none;">
    <!-- 顶部栏 -->
    <header class="header">
        <h1 class="header-title">掌上农场</h1>
        <p class="header-subtitle">全程溯源 · 安全放心</p>
    </header>

    <div class="container">
        <!-- 用户信息区 -->
        <div class="card">
            <div class="chicken-info">
                <img id="productImage" src="" alt="农家散养土鸡" class="chicken-image">
                <h3 id="productTitle" class="chicken-title">加载中...</h3>
            </div>
        </div>

        <!-- 首次查询时间 -->
        <div class="card">
            <div class="query-time">
                <h3 class="card-title">第一次查询时间</h3>
                <div class="time-info">
                    <i class="fas fa-check-circle check-icon"></i>
                    <span id="queryTime" class="time-text">加载中...</span>
                </div>
            </div>
        </div>

        <!-- 运动步数 -->
        <div class="card">
            <h3 class="card-title">运动步数</h3>
            <div class="steps-info">
                <div id="totalSteps" class="total-steps">0 步</div>
                <div class="steps-details">
                    <div class="detail-item">
                        <span class="label">活动记录天数：</span>
                        <span id="activityDays" class="value">0 天</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">日均步数：</span>
                        <span id="dailySteps" class="value">0 步</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 养殖环境 -->
        <div class="card">
            <h3 class="card-title">温度和湿度</h3>
            <div class="environment-info">
                <div class="temp-humidity">
                    <div class="env-item">
                        <i class="fas fa-thermometer-half"></i>
                        <span id="temperatureValue" class="env-value">-- ℃</span>
                    </div>
                    <div class="env-item">
                        <i class="fas fa-tint"></i>
                        <span id="humidityValue" class="env-value">-- %RH</span>
                    </div>
                </div>
                <div class="feeding-records">
                    <h3 class="card-title">喂养操作记录</h3>
                    <div class="record-grid">
                        <div id="feedingRecordsButton" class="record-item clickable">
                            <span class="record-label">饲喂次数：</span>
                            <div>
                                <span id="feedingCount" class="record-value">0 次</span>
                                <i class="fas fa-chevron-right arrow-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 监控画面 -->
        <div class="card">
            <h3 class="card-title">实时监控</h3>
            <div class="monitor-section" >
                <div class="player" id="videoPlayer">
                    <video id="videoElement" autoplay class="monitor-image">
                    </video>
                    <div id="playPauseButton" class="play-pause-button" style="display: none;">
                        <i class="fas fa-play" id="playIcon" ></i>
                        <i class="fas fa-pause" id="pauseIcon" style="display: none;"></i>
                    </div>
                </div>
                <div class="address">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="chickenHouseAddress">加载中...</span>
                </div>
            </div>
        </div>

        <!-- 商品信息 -->
        <div class="card">
            <h3 class="card-title">商品信息</h3>
            <div id="productInfoContainer" class="product-info">
                <!-- 商品信息将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- 养殖流程 -->
        <div class="card">
            <h3 class="card-title">养殖流程</h3>
            <div id="timelineContainer" class="timeline">
                <!-- 养殖流程将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>

    <!-- 底部栏 -->
    <footer class="footer">
        <div class="footer-features">
            <div class="feature-item">
                <i class="fas fa-qrcode"></i>
                <span>一物一码</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-eye"></i>
                <span>信息透明</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-shield-alt"></i>
                <span>拒绝假货</span>
            </div>
        </div>
        <div class="footer-copyright">
            <p>数据由参与方提供，溯源系统提供技术支持</p>
        </div>
    </footer>
    </div>

    <!-- 喂养操作记录页面 -->
    <div id="feedingRecordsPage" class="page" style="display: none;">
        <header class="page-header">
            <button id="backButton" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="page-title">喂养操作记录</h1>
        </header>

        <div id="feedingRecordsContainer" class="feeding-records-container">
            <!-- 喂养记录将通过JavaScript动态添加 -->
        </div>
    </div>
    <script src="../static/js/hls-1.4.14.min.js"></script>
    <script>
        // 全局变量
        let VIDEO_URL_TEST = 'https://srs.pxact.com/live/vbld6mb2kh.m3u8';
        let farmData = {};
        let productId = null;
        let tenantNum = null;
        let hlsPlayer = null;
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面
            init();
        });
        
        // 初始化函数
        function init() {
            // 获取产品ID
            getProductIdFromUrl();
            // 加载数据
            loadData();
            // 添加事件监听
            setupEventListeners();
        }
        
        function initPlayer(m3u8Url) {
            console.log('initPlayer', m3u8Url);
            const videoElement = document.getElementById('videoElement');
            
            // 如果已存在播放器实例，先销毁
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // 检查浏览器是否原生支持HLS
            if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                // 某些浏览器（如Safari）原生支持HLS
                videoElement.src = m3u8Url;
            } else if (Hls.isSupported()) {
                // 使用hls.js播放m3u8
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(m3u8Url);
                hlsPlayer.attachMedia(videoElement);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                    // 自动播放
                    videoElement.play().catch(e => {
                        console.log('自动播放失败，可能需要用户交互:', e);
                    });
                });
                
                hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('网络错误，尝试恢复...');
                                hlsPlayer.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('媒体错误，尝试恢复...');
                                hlsPlayer.recoverMediaError();
                                break;
                            default:
                                console.error('无法恢复的错误:', data);
                                hlsPlayer.destroy();
                                break;
                        }
                    }
                });
            } else {
                console.error('当前浏览器不支持HLS播放');
                return;
            }
            
            // 获取播放/暂停按钮元素
            const playPauseButton = document.getElementById('playPauseButton');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            let isPlaying = false;
            
            // 视频开始播放时更新状态
            videoElement.addEventListener('playing', () => {
                isPlaying = true;
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            });
            
            // 视频暂停时更新状态
            videoElement.addEventListener('pause', () => {
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            });
            
            // 鼠标悬停显示播放/暂停按钮
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.addEventListener('mouseenter', () => {
                playPauseButton.style.display = 'flex';
            });
            
            videoPlayer.addEventListener('mouseleave', () => {
                playPauseButton.style.display = 'none';
            });
            
            // 获取焦点时显示播放/暂停按钮
            videoElement.addEventListener('focus', () => {
                playPauseButton.style.display = 'flex';
            });
            
            videoElement.addEventListener('blur', () => {
                playPauseButton.style.display = 'none';
            });
            
            // 点击按钮播放/暂停
            playPauseButton.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePlayPause();
            });
            
            // 播放/暂停切换函数
            function togglePlayPause() {
                if (isPlaying) {
                    videoElement.pause();
                } else {
                    videoElement.play().catch(e => {
                        console.log('播放失败:', e);
                    });
                }
            }
        }
        // 设置事件监听
        function setupEventListeners() {
            // 喂养记录按钮点击事件
            document.getElementById('feedingRecordsButton').addEventListener('click', navigateToFeedingRecords);
            // 返回按钮点击事件
            document.getElementById('backButton').addEventListener('click', navigateToMain);
            // 重试按钮点击事件
            document.getElementById('retryButton').addEventListener('click', loadData);
        }
        
        // 从URL获取产品ID和租户编号
        function getProductIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            productId = urlParams.get('id') || 'recuT512gzx6yw'; // 默认值
            tenantNum = urlParams.get('num') || ''; // 租户编号
        }
        
        // 加载数据
        async function loadData() {
            showLoading(true);
            hideError();
            
            try {
                // 构建API请求URL，支持多租户参数
                let apiUrl = `/api/v1/farm/info?product_id=${productId}`;
                if (tenantNum) {
                    apiUrl += `&tenant_num=${tenantNum}`;
                }
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.code === 0) {
                    farmData = result.data;
                    updateUI();
                } else {
                    showError(result.message || '获取数据失败');
                }
            } catch (err) {
                showError('网络请求失败，请检查网络连接');
                console.error('API请求失败:', err);
            } finally {
                showLoading(false);
            }
        }
        
        // 更新UI
        function updateUI() {
            // 显示主页面
            document.getElementById('mainPage').style.display = 'block';
            
            // 更新产品信息
            updateProductInfo();
            
            // 更新查询时间
            updateQueryTime();
            
            // 更新温湿度数据
            updateTemperatureHumidity();
            
            // 更新喂养次数
            updateFeedingCount();
            
            // 更新鸡舍地址
            updateChickenHouseAddress();
            
            // 更新商品信息
            updateProductDetails();
            
            // 更新养殖流程
            updateBreedingProcess();
        }
        
        // 更新产品信息
        function updateProductInfo() {
            if (farmData.product_info) {
                // 更新产品标题
                if (farmData.product_info.标题) {
                    document.getElementById('productTitle').textContent = farmData.product_info.标题;
                }
                
                // 更新产品图片
                if (farmData.product_info.封面图) {
                    document.getElementById('productImage').src = farmData.product_info.封面图;
                }
                
                // 更新监控地址
                if (farmData.product_info.监控地址) {
                    const videoUrl = farmData.product_info.监控地址.trim();
                    initPlayer(videoUrl);
                }
            }
        }
        
        // 更新查询时间
        function updateQueryTime() {
            const queryTimeElement = document.getElementById('queryTime');
            if (farmData.product_info && farmData.product_info.查询时间) {
                // 将时间戳转换为日期字符串
                const date = new Date(farmData.product_info.查询时间);
                queryTimeElement.textContent = farmData.product_info.查询时间;
                
                // 计算活动记录天数（当前时间到第一次查询时间的天数）
                const now = new Date();
                const daysDiff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                document.getElementById('activityDays').textContent = daysDiff + ' 天';
                
                // 更新日均步数和总步数
                if (farmData.product_info.日均步数) {
                    const dailySteps = farmData.product_info.日均步数;
                    document.getElementById('dailySteps').textContent = dailySteps + ' 步';
                    
                    // 计算总步数 = 日均步数 * 活动记录天数
                    const totalSteps = dailySteps * daysDiff;
                    document.getElementById('totalSteps').textContent = totalSteps + ' 步';
                }
            } else {
                queryTimeElement.textContent = '暂无数据';
                document.getElementById('activityDays').textContent = '0 天';
                document.getElementById('dailySteps').textContent = '0 步';
                document.getElementById('totalSteps').textContent = '0 步';
            }
        }
        
        // 更新喂养次数
        function updateFeedingCount() {
            const feedingCountElement = document.getElementById('feedingCount');
            const count = farmData.statistics && farmData.statistics.feeding_count ? farmData.statistics.feeding_count : 0;
            feedingCountElement.textContent = count + ' 次';
        }
        
        // 更新鸡舍地址
        function updateChickenHouseAddress() {
            const addressElement = document.getElementById('chickenHouseAddress');
            if (farmData.product_info && farmData.product_info.地址) {
                addressElement.textContent = farmData.product_info.地址;
            } else {
                addressElement.textContent = '暂无地址信息';
            }
        }
        
        // 更新温湿度数据
        function updateTemperatureHumidity() {
            const temperatureElement = document.getElementById('temperatureValue');
            const humidityElement = document.getElementById('humidityValue');
            
            if (farmData.sensor) {
                // 从传感器数据中获取温度和湿度
                const temperature = farmData.sensor['温度'] || farmData.sensor['temperature'];
                const humidity = farmData.sensor['湿度'] || farmData.sensor['humidity'];
                
                if (temperature !== undefined && temperature !== null) {
                    temperatureElement.textContent = temperature + ' ℃';
                } else {
                    temperatureElement.textContent = '-- ℃';
                }
                
                if (humidity !== undefined && humidity !== null) {
                    humidityElement.textContent = humidity + ' %RH';
                } else {
                    humidityElement.textContent = '-- %RH';
                }
            } else {
                // 如果没有传感器数据，显示默认值
                temperatureElement.textContent = '-- ℃';
                humidityElement.textContent = '-- %RH';
            }
        }
        
        // 更新商品信息
        function updateProductDetails() {
            const container = document.getElementById('productInfoContainer');
            container.innerHTML = ''; // 清空容器
            
            if (farmData.product_info) {
                // 直接使用product_info中的字段作为商品信息
                const product_keys = ['商品名称', '是否有机', '国产/进口', '饲养农户', '养殖企业']
                product_keys.forEach(pkey => {
                    const row = document.createElement('div');
                    row.className = 'info-row';
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'info-label';
                    labelSpan.textContent = pkey + '：';
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'info-value';
                    valueSpan.textContent = farmData.product_info[pkey];
                    
                    row.appendChild(labelSpan);
                    row.appendChild(valueSpan);
                    container.appendChild(row);
                });
            }
        }
        
        // 更新养殖流程
        function updateBreedingProcess() {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = ''; // 清空容器
            
            if (farmData.breeding_process && farmData.breeding_process.length > 0) {
                farmData.breeding_process.forEach(process => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    
                    const dot = document.createElement('div');
                    dot.className = 'timeline-dot';
                    
                    const content = document.createElement('div');
                    content.className = 'timeline-content';
                    
                    const stage = document.createElement('div');
                    stage.className = 'timeline-stage';
                    
                    const img = document.createElement('img');
                    img.className = 'stage-image';
                    img.alt = process.process_name || process.name || '养殖流程';
                    
                    // 检查是否有图片字段
                    if (process.image) {
                        img.src = process.image;
                    } else if (process.images && process.images.length > 0) {
                        img.src = getImageUrl(process.images[0]);
                        
                        const badge = document.createElement('div');
                        badge.className = 'image-badge';
                        badge.textContent = process.images.length;
                        stage.appendChild(badge);
                    } else {
                        img.src = 'https://cdn.sxy21.cn/static/imgs/default-process.png';
                    }
                    
                    stage.appendChild(img);
                    
                    const info = document.createElement('div');
                    info.className = 'timeline-info';
                    
                    const title = document.createElement('h4');
                    title.textContent = process.process_name || process.name || '养殖流程';
                    
                    const time = document.createElement('p');
                    // 如果有时间戳，转换为日期字符串
                    time.textContent = process.operation_time || '时间未知';
                    
                    info.appendChild(title);
                    info.appendChild(time);
                    
                    content.appendChild(stage);
                    content.appendChild(info);
                    
                    item.appendChild(dot);
                    item.appendChild(content);
                    
                    container.appendChild(item);
                });
            }
        }
        
        // 更新喂养记录
        function updateFeedingRecords() {
            const container = document.getElementById('feedingRecordsContainer');
            container.innerHTML = ''; // 清空容器
            
            if (farmData.feeding_records && farmData.feeding_records.length > 0) {
                farmData.feeding_records.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'feeding-record-item';
                    
                    const header = document.createElement('div');
                    header.className = 'record-header';
                    
                    const foodInfo = document.createElement('div');
                    foodInfo.className = 'food-info';
                    
                    const foodName = document.createElement('div');
                    foodName.className = 'food-name';
                    foodName.textContent = record.food_name;
                    
                    const recordTime = document.createElement('div');
                    recordTime.className = 'record-time';
                    recordTime.textContent = record.operation_time || '时间未知';
                    
                    const operatorName = document.createElement('div');
                    operatorName.className = 'operator-name';
                    operatorName.textContent = '操作人：' + (record.operator || '未知');
                    
                    foodInfo.appendChild(foodName);
                    foodInfo.appendChild(recordTime);
                    foodInfo.appendChild(operatorName);
                    
                    const recordImage = document.createElement('div');
                    recordImage.className = 'record-image';
                    
                    if (record.images && record.images.length > 0) {
                        const img = document.createElement('img');
                        img.className = 'record-photo';
                        img.src = getImageUrl(record.images[0]);
                        img.alt = record.food_name + '喂养';
                        img.addEventListener('click', () => showImageGallery(record.record_id));
                        
                        const photoCount = document.createElement('div');
                        photoCount.className = 'photo-count';
                        photoCount.textContent = record.images.length;
                        
                        recordImage.appendChild(img);
                        recordImage.appendChild(photoCount);
                    } else {
                        const noImage = document.createElement('div');
                        noImage.className = 'no-image';
                        noImage.textContent = '无图片';
                        recordImage.appendChild(noImage);
                    }
                    
                    header.appendChild(foodInfo);
                    header.appendChild(recordImage);
                    
                    item.appendChild(header);
                    container.appendChild(item);
                });
            }
        }
        
        // 获取商品信息项 - 不再使用，直接在updateProductDetails中处理
        
        // 获取图片URL
        function getImageUrl(image) {
            if (typeof image === 'string') {
                return image;
            } else if (image && typeof image === 'object') {
                // 如果有file_token，使用代理接口
                if (image.file_token) {
                    return `/api/v1/img/${image.file_token}`;
                }
                // 否则使用原始URL（如果有的话）
                return image.url || image.tmp_url || image.name || '';
            }
            return '';
        }
        
        // 显示加载状态
        function showLoading(show) {
            document.getElementById('loadingContainer').style.display = show ? 'flex' : 'none';
        }
        
        // 显示错误信息
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorContainer.style.display = 'flex';
        }
        
        // 隐藏错误信息
        function hideError() {
            document.getElementById('errorContainer').style.display = 'none';
        }
        
        // 导航到喂养记录页面
        function navigateToFeedingRecords() {
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('feedingRecordsPage').style.display = 'block';
            updateFeedingRecords();
        }
        
        // 导航到主页面
        function navigateToMain() {
            document.getElementById('feedingRecordsPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
        }
        
        // 显示图片画廊
        function showImageGallery(recordId) {
            // 图片画廊功能，暂时只是日志输出
            console.log('显示图片画廊:', recordId);
        }
    </script>
</body>
</html>
