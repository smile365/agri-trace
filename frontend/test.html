<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>FLV 直播播放 - petite-vue + mpegts.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- petite-vue & mpegts.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.js"></script>
  <style>
    :root { --radius: 999px; --overlay-bg: rgba(0,0,0,.45); }
    body { margin: 0; background:#0b0b0b; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .player {
      width: min(96vw, 960px);
      aspect-ratio: 16 / 9;
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background:#111;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    video {
      width: 100%; height: 100%; object-fit: contain; background: #000;
    }
    /* 悬浮时显示控制层；未播放时常显 */
    .overlay {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      pointer-events: none; /* 默认不拦截事件，按钮本身开启事件 */
      transition: opacity .18s ease;
      opacity: 0;
    }
    .player:hover .overlay { opacity: 1; }
    .overlay.show { opacity: 1; } /* 初始未播放时可见 */
    .btn {
      pointer-events: auto;
      width: 84px; height: 84px;
      border-radius: var(--radius);
      background: var(--overlay-bg);
      backdrop-filter: blur(2px);
      border: 1px solid rgba(255,255,255,.15);
      display: grid; place-items: center;
      cursor: pointer;
      transition: transform .12s ease, background .2s ease;
    }
    .btn:hover { transform: scale(1.06); background: rgba(0,0,0,.55); }
    .btn svg { width: 40px; height: 40px; fill: #fff; }
    .badge {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,.55); color:#fff; font-size: 12px;
      padding: 4px 8px; border-radius: 999px; letter-spacing:.5px;
      user-select: none;
    }
    .err {
      position:absolute; inset:auto 12px 12px 12px;
      background: rgba(0,0,0,.6); color:#fff; padding:10px 12px;
      border-radius: 10px; font-size: 13px; line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="wrap" v-scope="App()">
    <div class="player"
         @mouseenter="hovered = true"
         @mouseleave="hovered = false">

      <video ref="video"
             autoplay 
             controls
             @play="playing = true"
             @pause="playing = false"
             @ended="playing = false">
      </video>



      <!-- 错误提示 -->
      <div class="err" v-if="error">
        播放出错：{{ error }}<br/>
        请确认 FLV 地址可访问，或在浏览器中尝试手动刷新。
      </div>
    </div>
  </div>

  <script>
    const FLV_URL = 'http://192.168.15.250:8080/live/livestream-a.flv';

    function App() {
      return {
        player: null,
        playing: false,
        hovered: false,
        error: '',
        ensurePlayerLoaded() {
            console.log("ensurePlayerLoaded");
          if (this.player || !window.mpegts || !mpegts.isSupported()) return;

          try {
            this.player = mpegts.createPlayer({
              type: 'flv',
              url: FLV_URL,
              // 直播常见设置：减小缓冲，尽量低延迟
              isLive: true, 
              enableStashBuffer: false, 
              liveSync: true
            });

            this.player.attachMediaElement(this.$refs.video);
            this.player.load();

            // 监听底层错误，便于反馈
            this.player.on(mpegts.Events.ERROR, (type, detail) => {
              this.error = `${type}${detail ? ' - ' + detail : ''}`;
            });
          } catch (e) {
            this.error = String(e?.message || e);
          }
        },
        async togglePlay() {
            console.log("togglePlay");
          try {
            await this.ensurePlayerLoaded();
            if (!this.player) {
              this.error = '当前环境不支持 mpegts.js（可能是浏览器不兼容）。';
              return;
            }
            if (this.playing) {
              this.$refs.video.pause();
            } else {
              // 某些浏览器需用户手势触发；我们在按钮点击里触发
              await this.$refs.video.play();
            }
          } catch (e) {
            this.error = String(e?.message || e);
          }
        },
        mounted() {
          console.log("mounted",document.getElementsByTagName('video'));
          // 预加载流但不自动播放，可减少首次点击延迟
          this.ensurePlayerLoaded();
          // 页面隐藏时自动暂停，返回时不自动播放
          document.addEventListener('visibilitychange', () => {
            if (document.hidden && this.playing) this.$refs.video.play();
          });
          // 页面卸载时清理
          window.addEventListener('beforeunload', () => this.cleanup());
        },
        cleanup() {
            console.log("cleanup");
          try {
            this.player?.destroy();
          } catch (_) {}
          this.player = null;
        },
        unmounted() { this.cleanup(); }
      };
    }

    PetiteVue.createApp().mount();
    var player = null;
        if (mpegts.getFeatureList().mseLivePlayback) {
            var videoElement = document.getElementsByTagName('video')[0];
            player = mpegts.createPlayer({
                type: 'flv', 
                url: 'http://192.168.15.250:8080/live/livestream-a.flv',
                isLive: true, 
                enableStashBuffer: false, 
                liveSync: true
            });
            player.attachMediaElement(videoElement);
            player.load();
        }
    
  </script>
</body>
</html>
